##### 3.4. 기본 펌웨어 구조

펌웨어는 하드웨어를 제어하고, 소프트웨어와 하드웨어 간의 인터페이스를 제공하는 중요한 소프트웨어입니다. 펌웨어의 구조는 일반적으로 초기화 코드, 메인 루프, 인터럽트 서비스 루틴(ISR)으로 구성됩니다. 이러한 구성 요소는 임베디드 시스템의 주요 기능을 구현하는 데 필수적입니다.

**1. 초기화 코드 (Initialization Code)**

초기화 코드는 시스템이 시작될 때 하드웨어와 소프트웨어를 설정하는 데 사용됩니다. 이 단계에서는 클럭 설정, 메모리 초기화, 주변 장치 설정 등이 포함됩니다.

**초기화 코드의 주요 작업**:
- **시스템 클럭 설정**: 마이크로컨트롤러의 클럭 소스를 설정하고, 필요한 경우 PLL(Phase-Locked Loop)을 사용하여 클럭 속도를 증가시킵니다.
- **메모리 초기화**: SRAM, 플래시 메모리 등을 초기화하고, 초기 값을 설정합니다.
- **주변 장치 설정**: GPIO, 타이머, UART, SPI, I2C 등의 주변 장치를 설정합니다.
- **인터럽트 설정**: 인터럽트를 활성화하고, 인터럽트 벡터를 설정합니다.

**예제 (STM32 초기화 코드)**:
```c
void SystemInit(void) {
    // 시스템 클럭 설정
    RCC->CR |= RCC_CR_HSEON; // 외부 클럭 활성화
    while (!(RCC->CR & RCC_CR_HSERDY)); // 클럭 준비 대기
    RCC->CFGR |= RCC_CFGR_SW_HSE; // 시스템 클럭 소스로 HSE 선택

    // GPIO 설정
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN; // GPIOA 클럭 활성화
    GPIOA->MODER |= (1 << (5 * 2)); // PA5를 출력 모드로 설정

    // 인터럽트 설정
    NVIC_EnableIRQ(EXTI0_IRQn); // EXTI0 인터럽트 활성화
}
```

**2. 메인 루프 (Main Loop)**

메인 루프는 시스템이 초기화된 후 지속적으로 실행되는 코드입니다. 메인 루프에서는 주기적으로 수행해야 하는 작업, 상태 모니터링, 이벤트 처리 등을 수행합니다.

**메인 루프의 주요 작업**:
- **상태 모니터링**: 센서 데이터 읽기, 시스템 상태 확인 등을 수행합니다.
- **이벤트 처리**: 입력 이벤트 처리, 출력 제어 등을 수행합니다.
- **주기적 작업**: 주기적으로 실행되어야 하는 작업(예: LED 깜빡이기)을 수행합니다.

**예제 (Arduino 메인 루프)**:
```cpp
void loop() {
    digitalWrite(LED_BUILTIN, HIGH); // LED 켜기
    delay(1000); // 1초 대기
    digitalWrite(LED_BUILTIN, LOW); // LED 끄기
    delay(1000); // 1초 대기
}
```

**3. 인터럽트 서비스 루틴 (ISR)**

인터럽트 서비스 루틴은 하드웨어 인터럽트가 발생했을 때 실행되는 코드입니다. ISR은 빠르고 효율적으로 인터럽트를 처리하고, 가능한 한 짧은 시간 내에 종료되어야 합니다.

**ISR의 주요 작업**:
- **인터럽트 플래그 클리어**: 인터럽트 플래그를 클리어하여 다음 인터럽트를 처리할 수 있도록 합니다.
- **인터럽트 처리**: 인터럽트 원인에 따라 필요한 작업을 수행합니다. 예를 들어, 타이머 인터럽트에서는 타이머 값을 업데이트하거나 주기적인 작업을 수행할 수 있습니다.
- **상태 저장 및 복원**: ISR이 실행되는 동안 영향을 받는 레지스터나 메모리의 상태를 저장하고, ISR 종료 시 복원합니다.

**예제 (AVR 타이머 인터럽트 서비스 루틴)**:
```c
ISR(TIMER1_COMPA_vect) {
    PORTB ^= (1 << PB0); // PB0 상태 토글
}
```

**펌웨어의 기본 구조**

펌웨어의 기본 구조는 다음과 같습니다:

```c
#include <avr/io.h>
#include <avr/interrupt.h>

// 초기화 함수
void init() {
    // 시스템 클럭 및 주변 장치 초기화
    // 예: 타이머 설정, GPIO 설정 등
    TCCR1B |= (1 << WGM12) | (1 << CS12); // CTC 모드, 프리스케일러 256
    TIMSK1 |= (1 << OCIE1A); // 타이머 비교 일치 인터럽트 활성화
    OCR1A = 62500; // 비교 일치 값 설정 (1초마다 인터럽트 발생)
    DDRB |= (1 << PB0); // PB0를 출력 모드로 설정
    sei(); // 전역 인터럽트 활성화
}

// 메인 루프
int main(void) {
    init(); // 초기화 함수 호출

    while (1) {
        // 메인 루프 코드
        // 예: 상태 모니터링, 이벤트 처리 등
    }

    return 0;
}

// 인터럽트 서비스 루틴
ISR(TIMER1_COMPA_vect) {
    PORTB ^= (1 << PB0); // PB0 상태 토글
}
```

이 구조를 바탕으로 펌웨어 개발자는 필요한 기능을 추가하고, 시스템 요구 사항에 맞게 코드를 작성할 수 있습니다. 초기화 코드에서 하드웨어를 설정하고, 메인 루프에서 주기적인 작업과 상태 모니터링을 수행하며, 인터럽트 서비스 루틴에서 실시간으로 발생하는 이벤트를 처리합니다.
